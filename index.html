<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°ˆæ¡ˆç®¡ç†ç³»çµ±</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
    .header { max-width: 1100px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 2px solid #ddd; }
    h1 { color: #2c3e50; margin: 0; }
    .nav-buttons a { text-decoration: none; padding: 10px 20px; margin-left: 10px; border-radius: 5px; font-weight: bold; color: white; }
    .btn-add { background-color: #27ae60; }
    .btn-closed { background-color: #7f8c8d; }
    
    .project-card { max-width: 1100px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .project-title { font-size: 20px; color: #2980b9; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; }
    
    /* æ–°å¢çš„å°ˆæ¡ˆèªªæ˜å€å¡Šè¨­è¨ˆ */
    .project-desc { background-color: #f8f9fa; border-left: 4px solid #f39c12; padding: 12px 15px; margin-bottom: 15px; font-size: 15px; color: #555; line-height: 1.6; border-radius: 0 4px 4px 0; }
    
    .task-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 14px; }
    .task-table th, .task-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    .task-table th { background-color: #ecf0f1; color: #2c3e50; }
    .gantt-container { width: 100%; height: auto; min-height: 150px; margin-top: 15px; overflow-x: auto; }
    
    .add-task-form { display: flex; gap: 10px; background: #f9f9f9; padding: 15px; border-radius: 5px; flex-wrap: wrap; margin-top: 20px; border: 1px dashed #ccc; }
    .add-task-form input { flex: 1; min-width: 120px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    .add-task-form button { background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .loading { text-align: center; color: #e67e22; font-weight: bold; padding: 20px; }
  </style>
</head>
<body>

<div class="header">
  <h1>ğŸ“Šå°ˆæ¡ˆç®¡ç†ç³»çµ±</h1>
  <div class="nav-buttons">
    <a href="form.html" class="btn-add">â• æ–°å¢å°ˆæ¡ˆ</a>
    <a href="closed.html" class="btn-closed">ğŸ“¦ å·²çµæ¡ˆ</a>
  </div>
</div>

<div id="loadingMsg" class="loading">è³‡æ–™èˆ‡ç”˜ç‰¹åœ–è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™... â³</div>
<div id="projectsContainer"></div>

<script>
  // æ›¿æ›æˆä½ çš„æœ€æ–° GAS ç¶²å€
  const scriptURL = 'https://script.google.com/macros/s/AKfycbx-v5TZahGINqu7xAryX6ZlZ54jrrk6-HDRTvQvnu7WZ0RxVhBnc85fQd1snihkCDpU/exec';
  
  google.charts.load('current', {'packages':['gantt']});
  google.charts.setOnLoadCallback(fetchData);

  function fetchData() {
    fetch(scriptURL + '?action=active')
      .then(response => response.json())
      .then(data => {
        document.getElementById('loadingMsg').style.display = 'none';
        if(data.result === 'success' && data.data.length > 1) {
          renderProjects(data.data);
        } else {
          document.getElementById('loadingMsg').style.display = 'block';
          document.getElementById('loadingMsg').textContent = 'ç›®å‰æ²’æœ‰åŸ·è¡Œä¸­çš„å°ˆæ¡ˆã€‚';
        }
      });
  }

  function renderProjects(rows) {
    const container = document.getElementById('projectsContainer');
    const projects = {};
    
    // å¾ç¬¬2åˆ—é–‹å§‹è®€å– (é¿é–‹è¡¨é ­)
    for(let i = 1; i < rows.length; i++) {
      let r = rows[i];
      let pId = r[0]; // Aæ¬„: å°ˆæ¡ˆç·¨è™Ÿ
      if(!pId) continue;
      
      // å»ºç«‹å°ˆæ¡ˆæ¯è³‡æ–™ (åŠ å…¥ r[5] å°ˆæ¡ˆèªªæ˜)
      if(!projects[pId]) {
        projects[pId] = { 
          name: r[2],       // Cæ¬„: å°ˆæ¡ˆåç¨±
          desc: r[5],       // Fæ¬„: å°ˆæ¡ˆèªªæ˜
          deadline: r[7],   // Hæ¬„: å®ŒæˆæœŸé™
          tasks: [] 
        };
      }
      // å¦‚æœ I æ¬„(å·¥ä½œé …ç›®)æœ‰å€¼ï¼Œæ‰æ¨å…¥ä»»å‹™æ¸…å–®
      if(r[8] && r[8].trim() !== "") {
        projects[pId].tasks.push({ 
          id: `task_${i}`, name: r[8], desc: r[9], owner: r[10], start: r[11], end: r[12], status: r[13] 
        });
      }
    }

    // æ¸²æŸ“æ¯å€‹å°ˆæ¡ˆçš„å¡ç‰‡
    for (const [pId, pData] of Object.entries(projects)) {
      let card = document.createElement('div');
      card.className = 'project-card';
      
      // 1. å°ˆæ¡ˆæ¨™é¡Œ
      let html = `<div class="project-title">ğŸ·ï¸ [${pId}] ${pData.name} (ç¸½æœŸé™: ${pData.deadline})</div>`;
      
      // 2. å°ˆæ¡ˆèªªæ˜å€å¡Š (å¦‚æœæœ‰å¡«å¯«èªªæ˜æ‰é¡¯ç¤º)
      if (pData.desc && pData.desc.trim() !== "") {
        // å°‡æ›è¡Œç¬¦è™Ÿè½‰ç‚º HTML çš„ <br> ä»¥ä¿ç•™æ’ç‰ˆ
        let formattedDesc = pData.desc.replace(/\n/g, '<br>');
        html += `<div class="project-desc"><strong>ğŸ“ å°ˆæ¡ˆèªªæ˜ï¼š</strong><br>${formattedDesc}</div>`;
      }
      
      // 3. ä»»å‹™è¡¨æ ¼
      html += `<table class="task-table"><tr><th>å·¥ä½œé …ç›®</th><th>èªªæ˜</th><th>è² è²¬äºº</th><th>èµ·å§‹æ—¥</th><th>é è¨ˆå®Œæˆæ—¥</th><th>ç‹€æ…‹</th></tr>`;
      
      if (pData.tasks.length > 0) {
        pData.tasks.forEach(t => {
          html += `<tr><td>${t.name}</td><td>${t.desc}</td><td>${t.owner}</td><td>${t.start}</td><td>${t.end}</td><td>${t.status}</td></tr>`;
        });
      } else {
        html += `<tr><td colspan="6" style="text-align:center; color:#95a5a6;">ç›®å‰å°šç„¡å·¥ä½œé …ç›®ï¼Œè«‹åœ¨ä¸‹æ–¹æ–°å¢ã€‚</td></tr>`;
      }
      html += `</table>`;

      // 4. ç”˜ç‰¹åœ–å®¹å™¨
      html += `<div id="gantt_${pId}" class="gantt-container"></div>`;

      // 5. æ–°å¢ä»»å‹™å°è¡¨å–®
      html += `
        <form class="add-task-form" onsubmit="submitTask(event, '${pId}')">
          <input type="hidden" name="action" value="addTask">
          <input type="hidden" name="projectId" value="${pId}">
          <input type="text" name="taskName" placeholder="å·¥ä½œé …ç›® (å¿…å¡«)" required>
          <input type="text" name="taskDesc" placeholder="ä»»å‹™èªªæ˜">
          <input type="text" name="taskOwner" placeholder="è² è²¬äºº" required>
          <input type="date" name="taskStart" required title="èµ·å§‹æ—¥">
          <input type="date" name="taskEnd" required title="é è¨ˆå®Œæˆæ—¥">
          <button type="submit">â• æ–°å¢ä»»å‹™</button>
        </form>
      `;
      card.innerHTML = html;
      container.appendChild(card);

      // 6. ç•«ç”˜ç‰¹åœ–
      if (pData.tasks.length > 0) {
        drawGantt(pId, pData.tasks);
      }
    }
  }

  function drawGantt(pId, tasks) {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Task ID');
    data.addColumn('string', 'Task Name');
    data.addColumn('string', 'Resource');
    data.addColumn('date', 'Start Date');
    data.addColumn('date', 'End Date');
    data.addColumn('number', 'Duration');
    data.addColumn('number', 'Percent Complete');
    data.addColumn('string', 'Dependencies');

    let validTasks = 0;
    tasks.forEach(t => {
      // ç¢ºä¿æ—¥æœŸä¸ç‚ºç©º
      if(t.start && t.end) {
        let start = new Date(t.start.split(' ')[0].replace(/\//g, '-'));
        let end = new Date(t.end.split(' ')[0].replace(/\//g, '-'));
        
        if (!isNaN(start.getTime()) && !isNaN(end.getTime())) {
          data.addRow([ t.id, t.name, t.owner, start, end, null, 0, null ]);
          validTasks++;
        }
      }
    });

    if(validTasks > 0) {
      var chart = new google.visualization.Gantt(document.getElementById(`gantt_${pId}`));
      chart.draw(data, { height: (validTasks * 40) + 40 }); 
    } else {
      document.getElementById(`gantt_${pId}`).innerHTML = "<span style='color:gray; font-size:12px;'>âš ï¸ æ—¥æœŸæ ¼å¼ä¸å®Œæ•´æˆ–ç¼ºå°‘ä»»å‹™ï¼Œç„¡æ³•ç”¢ç”Ÿç”˜ç‰¹åœ–ã€‚</span>";
    }
  }

  // é€å‡ºæ–°å¢å­ä»»å‹™
  function submitTask(e, pId) {
    e.preventDefault();
    const form = e.target;
    const btn = form.querySelector('button');
    btn.textContent = 'æ–°å¢ä¸­...';
    btn.disabled = true;

    fetch(scriptURL, { method: 'POST', body: new FormData(form)})
      .then(r => r.json())
      .then(d => {
        if(d.result === 'success') {
          location.reload(); 
        } else alert('éŒ¯èª¤:' + d.error);
      }).catch(() => { alert('é€£ç·šå¤±æ•—'); btn.textContent = 'â• æ–°å¢ä»»å‹™'; btn.disabled = false; });
  }
</script>

</body>
</html>
