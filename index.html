<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°ˆæ¡ˆç®¡ç†ç³»çµ±</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
    .header { max-width: 1100px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 2px solid #ddd; }
    h1 { color: #2c3e50; margin: 0; }
    .nav-buttons a { text-decoration: none; padding: 10px 20px; margin-left: 10px; border-radius: 5px; font-weight: bold; color: white; }
    .btn-add { background-color: #27ae60; }
    .btn-closed { background-color: #7f8c8d; }
    .project-card { max-width: 1100px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .project-title { font-size: 20px; color: #2980b9; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
    .task-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 14px; }
    .task-table th, .task-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
    .task-table th { background-color: #ecf0f1; }
    .gantt-container { width: 100%; height: auto; min-height: 150px; margin-top: 15px; overflow-x: auto; }
    .add-task-form { display: flex; gap: 10px; background: #f9f9f9; padding: 15px; border-radius: 5px; flex-wrap: wrap; }
    .add-task-form input { flex: 1; min-width: 120px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    .add-task-form button { background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .loading { text-align: center; color: #e67e22; font-weight: bold; padding: 20px; }
  </style>
</head>
<body>

<div class="header">
  <h1>ğŸ“Š å°ˆæ¡ˆç®¡ç†ç³»çµ±</h1>
  <div class="nav-buttons">
    <a href="form.html" class="btn-add">â• æ–°å¢å°ˆæ¡ˆ</a>
    <a href="closed.html" class="btn-closed">ğŸ“¦ å·²çµæ¡ˆ</a>
  </div>
</div>

<div id="loadingMsg" class="loading">è³‡æ–™èˆ‡ç”˜ç‰¹åœ–è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™... â³</div>
<div id="projectsContainer"></div>

<script>
  // æ›¿æ›æˆä½ çš„æœ€æ–° GAS ç¶²å€
  const scriptURL = 'https://script.google.com/macros/s/AKfycbx-v5TZahGINqu7xAryX6ZlZ54jrrk6-HDRTvQvnu7WZ0RxVhBnc85fQd1snihkCDpU/exec';
  
  google.charts.load('current', {'packages':['gantt']});
  google.charts.setOnLoadCallback(fetchData);

  function fetchData() {
    fetch(scriptURL + '?action=active')
      .then(response => response.json())
      .then(data => {
        document.getElementById('loadingMsg').style.display = 'none';
        if(data.result === 'success' && data.data.length > 1) {
          renderProjects(data.data);
        } else {
          document.getElementById('loadingMsg').style.display = 'block';
          document.getElementById('loadingMsg').textContent = 'ç›®å‰æ²’æœ‰åŸ·è¡Œä¸­çš„å°ˆæ¡ˆã€‚';
        }
      });
  }

  function renderProjects(rows) {
    const container = document.getElementById('projectsContainer');
    // è³‡æ–™çµæ§‹ï¼šåˆ†çµ„
    // A=0:ç·¨è™Ÿ, C=2:å°ˆæ¡ˆåç¨±, H=7:å®ŒæˆæœŸé™
    // I=8:å·¥ä½œé …ç›®, J=9:å·¥ä½œèªªæ˜, K=10:è² è²¬äºº, L=11:èµ·å§‹æ—¥, M=12:é è¨ˆå®Œæˆæ—¥, N=13:ç‹€æ…‹
    const projects = {};
    
    for(let i = 1; i < rows.length; i++) {
      let r = rows[i];
      let pId = r[0];
      if(!pId) continue;
      
      if(!projects[pId]) {
        projects[pId] = { name: r[2], deadline: r[7], tasks: [] };
      }
      // å¦‚æœè©²åˆ—æœ‰å·¥ä½œé …ç›®ï¼Œå°±åŠ é€²ä»»å‹™æ¸…å–®
      if(r[8]) {
        projects[pId].tasks.push({ id: `task_${i}`, name: r[8], desc: r[9], owner: r[10], start: r[11], end: r[12], status: r[13] });
      }
    }

    // æ¸²æŸ“æ¯å€‹å°ˆæ¡ˆçš„å¡ç‰‡
    for (const [pId, pData] of Object.entries(projects)) {
      let card = document.createElement('div');
      card.className = 'project-card';
      
      // æ¨™é¡Œèˆ‡ä»»å‹™è¡¨æ ¼
      let html = `<div class="project-title">ğŸ·ï¸ [${pId}] ${pData.name} (ç¸½æœŸé™: ${pData.deadline})</div>`;
      html += `<table class="task-table"><tr><th>å·¥ä½œé …ç›®</th><th>èªªæ˜</th><th>è² è²¬äºº</th><th>èµ·å§‹æ—¥</th><th>é è¨ˆå®Œæˆæ—¥</th><th>ç‹€æ…‹</th></tr>`;
      
      pData.tasks.forEach(t => {
        html += `<tr><td>${t.name}</td><td>${t.desc}</td><td>${t.owner}</td><td>${t.start}</td><td>${t.end}</td><td>${t.status}</td></tr>`;
      });
      html += `</table>`;

      // ç”˜ç‰¹åœ–å®¹å™¨
      html += `<div id="gantt_${pId}" class="gantt-container"></div>`;

      // æ–°å¢ä»»å‹™å°è¡¨å–®
      html += `
        <form class="add-task-form" onsubmit="submitTask(event, '${pId}')">
          <input type="hidden" name="action" value="addTask">
          <input type="hidden" name="projectId" value="${pId}">
          <input type="text" name="taskName" placeholder="å·¥ä½œé …ç›® (å¿…å¡«)" required>
          <input type="text" name="taskDesc" placeholder="èªªæ˜">
          <input type="text" name="taskOwner" placeholder="è² è²¬äºº" required>
          <input type="date" name="taskStart" required title="èµ·å§‹æ—¥">
          <input type="date" name="taskEnd" required title="é è¨ˆå®Œæˆæ—¥">
          <button type="submit">â• æ–°å¢ä»»å‹™</button>
        </form>
      `;
      card.innerHTML = html;
      container.appendChild(card);

      // ç•«ç”˜ç‰¹åœ–
      drawGantt(pId, pData.tasks);
    }
  }

  function drawGantt(pId, tasks) {
    if(tasks.length === 0) return;
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Task ID');
    data.addColumn('string', 'Task Name');
    data.addColumn('string', 'Resource');
    data.addColumn('date', 'Start Date');
    data.addColumn('date', 'End Date');
    data.addColumn('number', 'Duration');
    data.addColumn('number', 'Percent Complete');
    data.addColumn('string', 'Dependencies');

    let validTasks = 0;
    tasks.forEach(t => {
      // ç°¡æ˜“æ—¥æœŸè§£æ (æ”¯æ´ YYYY-MM-DD æˆ– YYYY/MM/DD)
      let start = new Date(t.start.split(' ')[0].replace(/\//g, '-'));
      let end = new Date(t.end.split(' ')[0].replace(/\//g, '-'));
      
      if (!isNaN(start.getTime()) && !isNaN(end.getTime())) {
        data.addRow([ t.id, t.name, t.owner, start, end, null, 0, null ]);
        validTasks++;
      }
    });

    if(validTasks > 0) {
      var chart = new google.visualization.Gantt(document.getElementById(`gantt_${pId}`));
      // ç”˜ç‰¹åœ–é«˜åº¦è‡ªé©æ‡‰
      chart.draw(data, { height: (validTasks * 40) + 40 }); 
    } else {
      document.getElementById(`gantt_${pId}`).innerHTML = "<span style='color:gray; font-size:12px;'>âš ï¸ æ—¥æœŸæ ¼å¼ä¸å®Œæ•´ï¼Œç„¡æ³•ç”¢ç”Ÿç”˜ç‰¹åœ–ã€‚</span>";
    }
  }

  // é€å‡ºæ–°å¢å­ä»»å‹™
  function submitTask(e, pId) {
    e.preventDefault();
    const form = e.target;
    const btn = form.querySelector('button');
    btn.textContent = 'æ–°å¢ä¸­...';
    btn.disabled = true;

    fetch(scriptURL, { method: 'POST', body: new FormData(form)})
      .then(r => r.json())
      .then(d => {
        if(d.result === 'success') {
          location.reload(); // æˆåŠŸå¾Œç›´æ¥é‡æ•´ç•«é¢åˆ·æ–°ç”˜ç‰¹åœ–
        } else alert('éŒ¯èª¤:' + d.error);
      }).catch(() => { alert('é€£ç·šå¤±æ•—'); btn.textContent = 'â• æ–°å¢ä»»å‹™'; btn.disabled = false; });
  }
</script>

</body>
</html>
